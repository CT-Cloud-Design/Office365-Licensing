function resetPageData(){PageData.Dragging=!1,PageData.Filename="",PageData.Highlighted=[],PageData.Highlighting=!1,PageData.MenuOffset=0,PageData.MenuOpen=!1,PageData.Flagged=!1,PageData.Flags=[],PageData.SavedImage=!1,PageData.SavedImageTitle="untitled",PageData.Scroll={Top:0,Left:0,X:0,Y:0},PageData.SvgTag=void 0,PageData.Zoom=100}function getSvgXml(){const e=' style="'+PageData.SvgTag.style.cssText+'"';let t=(new XMLSerializer).serializeToString(PageData.SvgTag).replace(e,"");return isIE&&(t=t.replace('xmlns:NS1="" NS1:xmlns:ev="http://www.w3.org/2001/xml-events"','xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events"')),t}function hideError(){document.getElementById("errorDiv").style.display="none"}function showError(e){resetPageData(),document.getElementById("errorMessage").innerText=e,document.getElementById("errorDiv").style.display="block",document.getElementById("menu").style.display="none",document.getElementsByTagName("svg").item(0).style.display="none"}function updateMenu(){const e=document.getElementById("menu"),t=document.getElementById("menuGrip"),a=document.getElementById("menuFlag"),n=document.getElementById("menuPdf"),i=document.getElementById("menuPng"),g=document.getElementById("menuSave"),l=document.getElementById("menuHighlight"),o=document.getElementById("menuExportSvg"),s=document.getElementById("menuExportPng");if(isIOSEdge){const e=document.getElementById("menuPrint");e.style.display="none"}PageData.Highlighting?(l.src="/media/edit-on.svg",l.title="Turn off highlighter"):(l.src="/media/edit-off.svg",l.title="Turn on highlighter"),PageData.Flagged?(a.src="/media/flagged.svg",a.title="Remove flag"):(a.src="/media/unflagged.svg",a.title="Flag this diagram"),PageData.Highlighting?(g.style.display="inline",o.style.display=isIOSEdge?"none":"inline",s.style.display=isIOSEdge||isIE?"none":"inline"):(g.style.display="none",o.style.display=PageData.SavedImage&&!isIOSEdge?"inline":"none",s.style.display=!PageData.SavedImage||isIE||isIOSEdge?"none":"inline"),PageData.SavedImage?(a.style.display="none",n.style.display="none",i.style.display="none"):(a.style.display="inline",PageData.Highlighting?(n.style.display="none",i.style.display="none"):(n.style.display="inline",i.style.display="inline")),e.style.display="block",PageData.MenuOffset=e.clientWidth-t.clientWidth-4}function appOffline(){document.getElementById("offline").style.display="block",updateMenu()}function appOnline(){document.getElementById("offline").style.display="none",updateMenu()}function wheelEvent(e){if(!PageData.SvgTag)return;if(e.preventDefault(),e.deltaY>-.1)PageData.Zoom-=PageData.Zoom>100?20:5;else{if(!(e.deltaY<.1))return;PageData.Zoom+=PageData.Zoom<100?5:20}PageData.Zoom>800?PageData.Zoom=800:PageData.Zoom<10&&(PageData.Zoom=10);const t=PageData.SvgTag.getAttribute("startwidth"),a=PageData.SvgTag.getAttribute("startheight"),n=PageData.SvgTag.clientWidth,i=PageData.SvgTag.clientHeight,g=Math.floor(t*PageData.Zoom/100),l=Math.floor(a*PageData.Zoom/100);PageData.SvgTag.style.width=g+"px",PageData.SvgTag.style.height=l+"px";const o=g/n,s=l/i,d=e.pageX*o,r=e.pageY*s,m=d-e.pageX,c=r-e.pageY;window.scroll(document.documentElement.scrollLeft+m,document.documentElement.scrollTop+c)}function setMenuPosition(){const e=document.getElementById("menu"),t=document.getElementById("menuGrip");PageData.MenuOpen?(t.title="Close menu",t.src="/media/close.svg",e.style.right=0):(t.title="Open menu",t.src="/media/open.svg",e.style.right=-PageData.MenuOffset+"px")}function menuGripClick(){PageData.MenuOpen=!PageData.MenuOpen,setMenuPosition()}function flagClick(e){if(e.preventDefault(),PageData.Flagged){const e=PageData.Flags.indexOf(PageData.Filename);e>-1&&PageData.Flags.splice(e,1),PageData.Flagged=!1}else PageData.Flags.push(PageData.Filename),PageData.Flagged=!0;localStorage.setItem(StoreName.Flags,JSON.stringify(PageData.Flags)),updateMenu()}function printClick(e){e.preventDefault(),window.print()}function menuHighlightClick(e){e.preventDefault(),PageData.Highlighting=!PageData.Highlighting,updateMenu()}function menuSaveClick(e){e.preventDefault();let t=decodeURIComponent(PageData.Filename),a=Date.now().toString(),n=!1;if(PageData.SavedImage&&(t=PageData.SavedImageTitle,n=customConfirm("Overwrite existing diagram?"),n&&(a=PageData.Filename)),n||(t=customPrompt("Save diagram as:",t)),!t)return;const i=getSvgXml(),g={Title:t,SvgXml:i},l=JSON.stringify(g);localStorage.setItem(a,l)}function exportSvgClick(e){e.preventDefault();const t=(PageData.SavedImage?PageData.SavedImageTitle:decodeURIComponent(PageData.Filename))+".svg",a=getSvgXml();exportSvg(t,a)}function exportPngClick(e){if(e.preventDefault(),isIE)return;const t=window.getComputedStyle(document.body).backgroundColor,a=(PageData.SavedImage?PageData.SavedImageTitle:decodeURIComponent(PageData.Filename))+".png",n=getSvgXml();exportPng(a,n,t)}function setupMenu(){document.getElementById("menuGrip").addEventListener("click",menuGripClick),document.getElementById("menuFlag").addEventListener("click",flagClick),document.getElementById("menuPrint").addEventListener("click",printClick),document.getElementById("menuHighlight").addEventListener("click",menuHighlightClick),document.getElementById("menuSave").addEventListener("click",menuSaveClick),document.getElementById("menuExportSvg").addEventListener("click",exportSvgClick),document.getElementById("menuExportPng").addEventListener("click",exportPngClick),PageData.MenuOpen="Open"===Settings.Menu}function clearAllHighlights(){for(let e=0;e<PageData.Highlighted.length;e+=1){const t=PageData.Highlighted[e];t.className.baseVal=t.className.baseVal.replace("highlight1","").replace("highlight2","").replace("highlight3","")}PageData.Highlighted=[]}function findHighlightTarget(e){let t=e;if("tspan"===t.nodeName&&(t=t.parentNode),"text"===t.nodeName&&(t=t.parentNode),"g"===t.nodeName){let e=t.getElementsByTagName("rect");if(0===e.length&&(e=t.getElementsByTagName("path")),0===e.length)return null;t=e.item(0)}return"rect"===t.nodeName||"path"===t.nodeName?t:null}function sizeSvg(){if(!PageData.SvgTag)return;let e=.985;switch(Settings.Zoom){case"Fit":e*=Math.min(window.innerWidth/PageData.SvgTag.clientWidth,window.innerHeight/PageData.SvgTag.clientHeight);break;case"Fit Width":e*=window.innerWidth/PageData.SvgTag.clientWidth;break;case"Fit Height":e*=window.innerHeight/PageData.SvgTag.clientHeight;break;case"Fill":e*=Math.max(window.innerWidth/PageData.SvgTag.clientWidth,window.innerHeight/PageData.SvgTag.clientHeight);break;default:return void showError("Unexpected Zoom setting value: "+Settings.Zoom)}const t=Math.floor(PageData.SvgTag.clientWidth*e),a=Math.floor(PageData.SvgTag.clientHeight*e);PageData.SvgTag.style.width=t+"px",PageData.SvgTag.style.height=a+"px",PageData.SvgTag.setAttribute("startwidth",t),PageData.SvgTag.setAttribute("startheight",a),PageData.Zoom=100}function auxClickEvent(e){e.button===Mouse.Button.Middle&&(e.preventDefault(),PageData.Highlighting?clearAllHighlights():sizeSvg())}function clickEvent(e){if(e.button!==Mouse.Button.Middle){if(PageData.Dragging)e.preventDefault(),PageData.Dragging=!1;else if(PageData.Highlighting){const t=findHighlightTarget(e.target);if(null===t)return;e.preventDefault();const a=t.className.baseVal.split(" ");let n="";if(a.contains("highlight1")?(a.remove("highlight1"),n="highlight1"):a.contains("highlight2")?(a.remove("highlight2"),n="highlight2"):a.contains("highlight3")&&(a.remove("highlight3"),n="highlight3"),""===n){let n="";n=e.ctrlKey?"highlight3":e.shiftKey?"highlight2":"highlight1",a.push(n),PageData.Highlighted.push(t)}else PageData.Highlighted.remove(t);t.className.baseVal=a.join(" ")}}else auxClickEvent(e)}function mouseDown(e){e.buttons===Mouse.Buttons.Left?(PageData.Scroll.Left=document.documentElement.scrollLeft,PageData.Scroll.Top=document.documentElement.scrollTop,PageData.Scroll.X=e.clientX,PageData.Scroll.Y=e.clientY):e.buttons===Mouse.Buttons.Middle&&e.preventDefault()}function mouseMove(e){e.buttons===Mouse.Buttons.Left&&(PageData.Scroll.X===e.clientX&&PageData.Scroll.Y===e.clientY||(e.preventDefault(),PageData.Dragging=!0,window.scroll(PageData.Scroll.Left+PageData.Scroll.X-e.clientX,PageData.Scroll.Top+PageData.Scroll.Y-e.clientY)))}function setDownloads(e){const t=document.getElementById("menuPdf"),a=document.getElementById("menuPng");t.setAttribute("href","/"+e+".pdf"),t.setAttribute("download",e+".pdf"),a.setAttribute("href","/"+e+".png"),a.setAttribute("download",e+".png")}function loadSvg(e){document.body.removeChild(PageData.SvgTag),PageData.SvgTag=null;let t=e.replace(/<!--.*-->/i,"").replace(/<\?xml.*\?>/i,"").replace(/<!doctype.*>/i,"").replace(/^[\n\r]+/,"");if(-1===t.indexOf("m365MapsHighlights")){const e='<style id="m365MapsHighlights">.highlight1{fill:'+Settings.Highlight1+"!important;transition:0.4s;}.highlight2{fill:"+Settings.Highlight2+"!important;transition:0.4s;}.highlight3{fill:"+Settings.Highlight3+"!important;transition:0.4s;}</style>";t=t.replace(/<\/svg>/i,e+"</svg>")}PageData.SvgTag=createElementFromHtml(t),document.body.appendChild(PageData.SvgTag),PageData.SvgTag.addEventListener("click",clickEvent),PageData.SvgTag.addEventListener("auxclick",auxClickEvent),PageData.Flagged=!PageData.SavedImage&&-1!==PageData.Flags.indexOf(PageData.Filename),sizeSvg(),updateMenu(),setMenuPosition()}function hashChange(){hideError();let e=window.location.href.indexOf("#");if(-1===e&&(e=window.location.href.indexOf("=")),-1!==e&&e!==window.location.href.length-1)if("*"===window.location.href[e+1]){PageData.SavedImage=!0,PageData.Filename=window.location.href.substring(e+2);const t=localStorage.getItem(PageData.Filename);if(!t)return void showError("Failed to load saved diagram");const a=JSON.parse(t);if(!a||!a.SvgXml)return void showError("Failed to process saved diagram data");PageData.SavedImageTitle=a.Title,document.title=PageData.SavedImageTitle,loadSvg(a.SvgXml)}else{PageData.SavedImage=!1,PageData.Filename=window.location.href.substring(e+1);const t=decodeURIComponent(PageData.Filename);if("fetch"in window)fetch("/"+PageData.Filename+".svg").then(function(e){if(!e.ok)throw new Error(e.statusText+"("+e.status+")");return document.title=t,setDownloads(t),e.text()}).then(function(e){if(!e)throw new Error("Empty file");loadSvg(e)}).catch(function(e){showError(e.message)});else{const e=new XMLHttpRequest;e.open("GET","/"+PageData.Filename+".svg"),e.onload=function(e){if(200!==e.target.status)throw new Error(e.target.response);document.title=t,setDownloads(t),loadSvg(e.target.response)},e.onerror=function(e){showError(e.message)},e.send()}}else showError("Missing file name")}function pageLoad(){const e=localStorage.getItem(StoreName.Flags);if(e){const t=JSON.parse(e);t&&(PageData.Flags=t)}PageData.SvgTag=document.getElementsByTagName("svg").item(0),setupMenu(),hashChange(),window.addEventListener("hashchange",hashChange),window.addEventListener("mousedown",mouseDown),window.addEventListener("mousemove",mouseMove),window.addEventListener("wheel",wheelEvent,{passive:!1}),document.getElementById("offline").style.display=navigator.onLine?"none":"block",window.addEventListener("offline",appOffline),window.addEventListener("online",appOnline)}const PageData={};registerServiceWorker(),window.addEventListener("load",pageLoad),resetPageData(),loadSettings(),setTheme(Settings.Theme),addThemeListener(themeChange);